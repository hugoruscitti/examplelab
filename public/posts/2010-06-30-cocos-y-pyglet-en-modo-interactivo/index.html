<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Cocos y pyglet en modo interactivo :: Examplelab — Mi blog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Python tiene una herramienta super interesante para los nuevos programadores: una consola interactiva donde se puede editar, corregir y ejecutar código de manera super sencilla.
Esto resulta de mucha utilidad cuando quieres dar clases sobre programación o simplemente dar una demostración sobre alguna biblioteca.
Introducción Lamentablemente la consola de python no se puede usar en cualquier escenario, por ejemplo si quieres dar una demostración de la biblioteca cocos2d desde la consola interactiva se te pueden presentar algunos problemas."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2010-06-30-cocos-y-pyglet-en-modo-interactivo/" />




<script src="/js/turbolinks-5.2.0.js"></script>
<script src="/js/menu.js"></script>
<script src="/js/prism.js"></script>
<script src="/js/theme.js"></script>


<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">
<link rel="stylesheet" href="/css/estilo.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cocos y pyglet en modo interactivo"/>
<meta name="twitter:description" content="Python tiene una herramienta super interesante para los nuevos programadores: una consola interactiva donde se puede editar, corregir y ejecutar código de manera super sencilla.
Esto resulta de mucha utilidad cuando quieres dar clases sobre programación o simplemente dar una demostración sobre alguna biblioteca.
Introducción Lamentablemente la consola de python no se puede usar en cualquier escenario, por ejemplo si quieres dar una demostración de la biblioteca cocos2d desde la consola interactiva se te pueden presentar algunos problemas."/>



<meta property="og:title" content="Cocos y pyglet en modo interactivo" />
<meta property="og:description" content="Python tiene una herramienta super interesante para los nuevos programadores: una consola interactiva donde se puede editar, corregir y ejecutar código de manera super sencilla.
Esto resulta de mucha utilidad cuando quieres dar clases sobre programación o simplemente dar una demostración sobre alguna biblioteca.
Introducción Lamentablemente la consola de python no se puede usar en cualquier escenario, por ejemplo si quieres dar una demostración de la biblioteca cocos2d desde la consola interactiva se te pueden presentar algunos problemas." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2010-06-30-cocos-y-pyglet-en-modo-interactivo/" />
<meta property="article:published_time" content="2010-06-30T15:00:00+00:00" />
<meta property="article:modified_time" content="2010-06-30T15:00:00+00:00" /><meta property="og:site_name" content="Examplelab" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">examplelab</span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about/index.html">Acerca de</a></li>
        
      
        
          <li><a href="/posts/index.html">Artículos</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about/index.html">Acerca de</a></li>
      
    
      
        <li><a href="/posts/index.html">Artículos</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2010-06-30-cocos-y-pyglet-en-modo-interactivo/">Cocos y pyglet en modo interactivo</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2010-06-30
        </span>
      
      
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/python/">python</a>&nbsp;
        
          #<a href="/tags/interprete/">interprete</a>&nbsp;
        
          #<a href="/tags/pyglet/">pyglet</a>&nbsp;
        
          #<a href="/tags/cocos2d/">cocos2d</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <p>Python tiene una herramienta super interesante para los nuevos programadores: una consola interactiva donde se puede editar, corregir y ejecutar código de manera super sencilla.</p>
<p>Esto resulta de mucha utilidad cuando quieres dar clases sobre programación o simplemente dar una demostración sobre alguna biblioteca.</p>
<h2 id="introducción">Introducción</h2>
<p>Lamentablemente la consola de python no se puede usar en cualquier escenario, por ejemplo si quieres dar una demostración de la biblioteca <a href="http://cocos2d.org/">cocos2d</a> desde la consola interactiva se te pueden presentar algunos problemas.</p>
<p>Mediante este artículo intentaré encontrarle una solución a este problema, y en el camino veremos
Una aclaración inicial</p>
<p>Por cierto, <a href="http://cocos2d.org/">cocos2d</a> viene con una consola interactiva que se activa con las teclas <code>&lt;CTRL+I&gt;</code>.</p>
<p>Esa consola se ve dentro de la misma ventana de la aplicación y te permite hacer casi todo lo que veremos aquí.</p>
<p>La diferencia entre esa consola, y la que vamos a tratar de implementar aquí es la siguiente: en este artículo busco intergrar la consola de python tradicional, donde se puede copiar, pegar y autocompletar código.</p>
<h2 id="un-prototipo-de-ejemplo-para-descargar">Un prototipo de ejemplo para descargar</h2>
<p>La solución que veremos en este artículo me ha servido para realizar un prototipo de ejemplo.</p>
<p>Si quieres ir viendo el programa en funcionamiento lo puedes descargar de la siguiente dirección:</p>
<ul>
<li><a href="http://examplelab.googlecode.com/hg/interactive_cocos/interactive_cocos.py">http://examplelab.googlecode.com/hg/interactive_cocos/interactive_cocos.py</a></li>
</ul>
<p>donde la imagen que utilizo para representar el objeto animado principal está aquí:</p>
<p><img src="/images/2013/Oct/cara.png" alt=""></p>
<h2 id="cómo-se-utiliza-el-prototipo-de-consola">¿Cómo se utiliza el prototipo de consola?</h2>
<p>Primero tienes que descargar el script de la aplicación y ejecutarlo con el siguiente comando:</p>
<pre><code>python interactive_cocos2d.py
</code></pre>
<p>Luego, se abrirá una pantalla con un sprite que podrás manipular:</p>
<p><img src="/images/2013/Oct/screen_cara.png" alt=""></p>
<p>Por ejemplo, dentro de la consola python tiene dos referencias iniciales: cocos y sprite. Hagamos algo con ellas:</p>
<pre><code>sprite.rotate = 40
</code></pre>
<p>obteniendo:</p>
<p><img src="/images/2013/Oct/rotate.png" alt=""></p>
<p>Esto es útil para mostrar que el objeto en cuestión tiene atributos, y que se pueden manipular de manera sencilla.</p>
<p>También puedes ejecutar sentencias como <code>help(cocos)</code> o similares.</p>
<p>Ahora bien, con este escenario resulta mas interesante hablar sobre una de las características mas lindas que tiene <a href="http://cocos2d.org/">cocos2d</a>, el submódulo actions:</p>
<pre><code>media_vuelta = cocos.actions.RotateBy(180, 2)
giro_completo = media_vuelta * 2

sprite.do(giro_completo)
</code></pre>
<p>Eso mostrará una animación de rotación completa en 4 segundos. Y como ninguna acción detiene nuesta consola de python, podemos incluso seguir escribiendo mienstras se ejecuta la acción.</p>
<h2 id="cómo-funciona">¿Cómo funciona?</h2>
<p>A continuación veremos paso a paso la implementación del prototipo que se utiliza mas arriba.</p>
<h2 id="objetivo">Objetivo</h2>
<p>Quisieramos ejecutar nuestro intérprete de python tradicional en primer plano, y que la ventana de la biblioteca <a href="http://cocos2d.org/">cocos2d</a> permanezca en segundo plano.</p>
<p>Esto nos facilitaría jugar con la biblioteca, conocer sus funciones y manipular sprites de manera interactiva.
Un primer paso: ¿usamos hilos?</p>
<p>Como queremos poner en funcionamiento una ventana de <a href="http://cocos2d.org/">cocos2d</a> y al mismo tiempo tener un intérprete, podríamos usar dos hilos: Uno para el interprete que recibe los comandos del usuario y otro para la biblioteca <a href="http://cocos2d.org/">cocos2d</a>.</p>
<h2 id="el-problema-hilos-y-opengl">El problema: Hilos y OpenGL</h2>
<p>Lo malo de este enfoque es que opengl (la biblioteca base debajo de <a href="http://cocos2d.org/">cocos2d</a>) define un contexto y espera que todas las llamadas de opengl se hagan desde el mismo hilo que ha creado el contexto. Y esto es un problema, porque en realidad para nuestro escenario lo ideal sería manipular opengl desde un hilo (la consola) y ver los cambios en otro hilo (el de cocos).</p>
<p>Entonces, al parecer tenemos como restricción que todo lo que actúa directamente sobre opengl tiene que ejecutarse dentro del mismo hilo que utiliza cocos.</p>
<h2 id="el-modelo-propuesto">El modelo propuesto</h2>
<p>Podemos tener dos hilos en ejecución, y una cola de mensajes que permite derivar todo el código a ejecutar dentro del hilo de cocos.</p>
<p>Este es un gráfico de la solución propuesta:</p>
<p><img src="/images/2013/Oct/esquema.png" alt=""></p>
<h2 id="creando-un-prototipo">Creando un prototipo</h2>
<p>El programa principal solamente tiene que poner en funcionamiento a los tres componentes juntos:</p>
<pre><code># Cola de mensajes que se utiliza para llevar comandos al hilo.
queue = Queue.Queue()

# Hilo que ejecuta la funcionalidad de cocos.
app = Application(queue)
app.start()

# Interprete de comandos que envia todas las lineas que se escriben
# directamente a la cola de mensajes que consume el hilo.
cmd = CommandLine(app, queue)
cmd.cmdloop()
</code></pre>
<p>Donde queue es la cola que se utiliza para enviar o delegar todas las cadena de texto que ingresa el usuario.</p>
<h2 id="el-intérprete">El intérprete</h2>
<p>Para crear el intérprete que acepta los comandos del usuario he utilizado la clase Cmd del módulo cmd:</p>
<pre><code>class CommandLine(cmd.Cmd):

    def __init__(self, app, queue):
        cmd.Cmd.__init__(self, 'TAB')
        self.queue = queue
        self.app = app
        self.prompt = &quot;&gt;&gt;&gt; &quot;

    def default(self, line):
        &quot;Cualquier sentencia la envia a la cola de comandos que consume cocos.&quot;
        self.queue.put(line)

    def do_exit(self, line):
        self.app.kill()
        sys.exit(0)
</code></pre>
<p>La clase Cmd permite crear un intérprete de comandos parecido al original de python, incluido el autocompletado con la tecla TAB.</p>
<h2 id="hilo-de-cocos">Hilo de cocos</h2>
<p>El hilo que muestra la ventana de <a href="http://cocos2d.org/">cocos2d</a> solo tiene que mantener una ventana de la biblioteca visible y actualizar con frecuencia el contexto que ejecuta comandos:</p>
<pre><code>class Application(threading.Thread):

    def __init__(self, queue):
        threading.Thread.__init__(self)
        self.killed = False
        self.queue = queue

    def run(self):
        cocos.director.director.init(resizable=False, width=800, height=600)
        self.scene = cocos.scene.Scene(cocos.layer.ColorLayer(240, 240, 240, 255))
        sprite = cocos.sprite.Sprite('cara.png')
        sprite.scale = 2
        sprite.x = 400
        sprite.y = 300
        self.scene.add(sprite)

        # Genera el entorno de la session, y le pasa datos que puede
        # manipular.
        self.environment = environment(queue, sprite)
        self.environment.next()

        self.scene.schedule_interval(self.environment_update, 0.01)
        cocos.director.director.run(self.scene)

    def environment_update(self, dt):
        &quot;Mantiene en funcionamiento.&quot;
        self.environment.next()

    def kill(self):
        self.killed = True
        pyglet.app.exit()
</code></pre>
<h2 id="un-entorno-donde-viven-las-referencias">Un entorno donde viven las referencias</h2>
<p>La parte mas importante del sistema es la que se encarga de ejecutar el código que escribimos en consola.</p>
<p>Para ello he creado un generador, que conoce la cola de donde lee los mensajes que escribimos y los pone en funcionamiento.</p>
<p>Y dado que se trata de un generador, todo lo que se ejecuta dentro de él se mantiene en la memoria local, representando de alguna manera el contexto o espacio de nombres que buscamos conservar.</p>
<pre><code>def environment(queue, sprite):
    &quot;&quot;&quot;Representa la session y las variables locales de la instancia interactiva.

    Este entorno funciona como un generador, con la intension de guardar
    el estado de todas las variables locales y acceder a los comandos desde
    la cola.&quot;&quot;&quot;

    while True:

        try:
            last = queue.get_nowait()

            if last:
                try:
                    exec(last)
                except:
                    print &quot;Error al ejecutar&quot;, last

        except Queue.Empty:
            pass

        yield None
</code></pre>
<p>Nota: Un enfoque similar usan las aplicaciones REPL, donde incluso existe la funcionalidad de reiniciar el contexto cuando hemos hecho algo mal.</p>
<h2 id="conclusión">Conclusión</h2>
<p>Python ofrece una gran flexibilidad, y si bien creo que la solución al problema planteado se puede mejorar, actualmente puede ser de utilidad para otras personas.</p>
<p>Personalmente, lo encuentro útil para explicar algunos conceptos de programación mediante un enfoque práctico. Ideas como abstracción, encapsulación o polimorfismo quedan mas claras si se las puede reflejar con un ejemplo visible.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Leer otros artículos</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/posts/2010-07-22-creando-inte%CC%81rpretes-interactivos-con-python/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Creando intérpretes interactivos con python</span>
                </a>
              </span>
            
            
          </div>
        </div>
      
    
    

    
      
        

      
    
    
    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">examplelab</span>
  
</a>

      <div class="copyright">
        <span>© 2010-2020 Hugo Ruscitti</span>
      </div>
    
  </div>
</footer>


<script src="/assets/prism.js"></script>


      
    </div>
  </body>
</html>
